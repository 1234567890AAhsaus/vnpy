# Internationalization (i18n)

This document outlines the i18n process. Using the steps in this guide, multi-language support can be incorporated into VeighNa using standard Python conventions

References:
* https://docs.python.org/3.10/library/i18n.html
* https://simpleit.rocks/python/how-to-translate-a-python-project-with-gettext-the-easy-way/
* https://www.mattlayman.com/blog/2015/i18n/

## prerequisites

* [gettext](https://www.gnu.org/software/gettext/)
  - Linux/Mac: `brew install gettext`
  - Windows: https://mlocati.github.io/articles/gettext-iconv-windows.html (or similar)


## mark messages

The first step is to *mark* message strings for translation. We do this by wrapping the string with a special function. Example:

```python
output("优化参数组合为空，请检查")
```

becomes 

```python
from ..locale import _

output(_("优化参数组合为空，请检查"))
```

or, a parameterised message 

```python
output("参数优化空间：{}".format(len(settings)))
```

becomes

```python
from ..locale import _

output(_("参数优化空间：{}").format(len(settings)))
```

as unfortunately f-strings are not supported. One way to search for Chinese characters is to use the regex `\p{InCJK_UNIFIED_IDEOGRAPHS}` 

## template files

Once all the messages are marked, we run `xgettext` to extract the translatable strings into a message template file 

```shell
xgettext -o vnpy/locale/base.pot `find ./vnpy -name "*.py"`
```

## individual language files

We then create individual language files, by copying the template. So for English and Spanish

```shell
mkdir -p vnpy/locale/{en, es}/LC_MESSAGES
cp vnpy/locale/vnpy.pot vnpy/locale/en/LC_MESSAGES/vnpy.po
cp vnpy/locale/vnpy.pot vnpy/locale/es/LC_MESSAGES/vnpy.po
```

Then edit the .po files to add the translated text, updating the `msgstr` attributes. So for English (`vnpy/locale/en/LC_MESSAGES/vnpy.po`):

```
#: vnpy/trader/optimize.py:45
msgid "固定参数添加成功"
msgstr ""

#: vnpy/trader/optimize.py:48
msgid "参数优化起始点必须小于终止点"
msgstr ""
```

becomes

```
#: vnpy/trader/optimize.py:45
msgid "固定参数添加成功"
msgstr "Fixed parameters added successfully"

#: vnpy/trader/optimize.py:62
msgid "范围参数添加成功，数量{}"
msgstr "Range parameter added successfully, quantity {}"
```

See these projects for automation of the translation step:
* https://www.deepl.com/translator
* https://poeditor.com/
* https://www.transifex.com/

Quality of the automatic translation services is variable, and not always free. But they do at least provide a starting point. Sometimes a string will require a manual edit.

## binary files

The plain text languages files (*.po) must be converted into the binary format (.mo) used at runtime. This would be normally done at the build stage. But to do it manually during development or testing:

```shell
msgfmt -o vnpy/locale/en/LC_MESSAGES/vnpy.mo vnpy/locale/en/LC_MESSAGES/vnpy
```

## install

```shell
pip install . 
```

## execution

Now run the application, with your chosen language specified

```shell
LANG=en python vnpy/examples/veighna_trader/run.py 
```

or, set the environment variable `LANG` first, then run as normal. The  names 'LANGUAGE', 'LC_ALL', 'LC_MESSAGES' also work

## distribution

TBD
